<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat with <%= @chat_room.expert.name %> - MoneyMap</title>
  <%= stylesheet_link_tag "application", "users/user_dashboard", media: "all" %>
</head>
<body>
  <!-- Header -->
  <header>
    <div class="logo-container">
      <%= image_tag "money_map.png", alt: "MoneyMap Logo" %>
    </div>
    <div class="profile-container">
      <button class="profile-container">
        <%= link_to "ðŸ‘¤", profile_path, method: :delete, class: "profile-icon" %>
      </button>
      <nav>
        <button><%= link_to "Log Out", signin_path, method: :delete, class: "logout" %></button>
      </nav>
    </div>
  </header>

  <!-- Sidebar -->
  <aside class="sidebar">
    <%= link_to "Dashboard", 
        dashboard_path, 
        class: "#{current_page?(dashboard_path) ? 'active' : ''}", 
        onclick: "setTimeout(function() { window.location.reload(); }, 100)" %>
  
    <%= link_to "Enter / Edit Spends", 
        expenses_path, 
        class: "#{current_page?(expenses_path) ? 'active' : ''}", 
        onclick: "setTimeout(function() { window.location.reload(); }, 100)" %>
  
    <%= link_to "Expert Opinion", 
        expert_opinion_path,
        class: "#{current_page?(expert_opinion_path) ? 'active' : ''}" %>

    <%= link_to "Live Chat ðŸ’¬", chat_rooms_path, class: "#{current_page?(chat_rooms_path) ? 'active' : ''}" %>
  </aside>

  <!-- Main Content -->
  <main class="content">
    <h1>Chat with <%= @chat_room.expert.name %></h1>
    <div class="chat-window">
              <div id="messages" data-chat-room-id="<%= @chat_room.id %>">
            <% @messages.each do |message| %>
              <div class="message">
                <strong><%= message.sender.name %>:</strong>
                <span><%= message.content %></span>
                <small><%= message.created_at.strftime("%H:%M") %></small>
              </div>
            <% end %>
          </div>
        <%= form_with model: [@chat_room, Message.new], id: "message-form", remote: true do |form| %>
          <%= form.text_field :content, id: "message-input", placeholder: "Type your message..." %>
          <%= form.submit "Send", id: "send-button"
           %>
        <% end %>
    </div>
  </main>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const messageForm = document.getElementById("message-form");
    const messageInput = document.getElementById("message-input");

    messageForm.addEventListener("submit", (event) => {
      event.preventDefault();

      const content = messageInput.value.trim();
      if (content === "") return;

      // Get sender type and ID based on who is logged in
      const senderType = "<%= current_user ? 'User' : 'Expert' %>";
      const senderId = "<%= current_user ? current_user.id : current_expert.id %>";
      const chatRoomId = document.getElementById("messages").dataset.chatRoomId;

      fetch(`/chat_rooms/${chatRoomId}/messages`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRF-Token": document.querySelector("[name='csrf-token']").content
        },
        body: JSON.stringify({
          message: {
            content: content,
            sender_type: senderType,
            sender_id: senderId
          }
        })
      })
      .then(response => {
        if (response.ok) messageInput.value = "";
      })
      .catch(error => console.error("Error:", error));
    });
  });
</script>

</body>
</html>