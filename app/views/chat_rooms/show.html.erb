<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat with <%= @chat_room.expert.name %> - MoneyMap</title>
  <%= stylesheet_link_tag "application", "users/user_dashboard", media: "all" %>
</head>
<body>
  <!-- Header -->
  <header>
    <div class="logo-container">
      <%= image_tag "money_map.png", alt: "MoneyMap Logo" %>
    </div>
    <div class="profile-container">
      <button class="profile-container">
        <%= link_to "ðŸ‘¤", profile_path, method: :delete, class: "profile-icon" %>
      </button>
      <nav>
        <button><%= link_to "Log Out", signin_path, method: :delete, class: "logout" %></button>
      </nav>
    </div>
  </header>

  <!-- Sidebar -->
  <aside class="sidebar">
    <%= link_to "Dashboard", 
        dashboard_path, 
        class: "#{current_page?(dashboard_path) ? 'active' : ''}", 
        onclick: "setTimeout(function() { window.location.reload(); }, 100)" %>
  
    <%= link_to "Enter / Edit Spends", 
        expenses_path, 
        class: "#{current_page?(expenses_path) ? 'active' : ''}", 
        onclick: "setTimeout(function() { window.location.reload(); }, 100)" %>
  
    <%= link_to "Expert Opinion", 
        expert_opinion_path,
        class: "#{current_page?(expert_opinion_path) ? 'active' : ''}" %>

    <%= link_to "Live Chat ðŸ’¬", chat_rooms_path, class: "#{current_page?(chat_rooms_path) ? 'active' : ''}" %>
  </aside>

  <!-- Main Content -->
  <main class="content">
    <h1>Chat with <%= @chat_room.expert.name %></h1>
    <div class="chat-window">
      <div id="messages" data-chat-room-id="<%= @chat_room.id %>">
        <% @messages.each do |message| %>
          <%= render partial: 'messages/message', locals: { message: message } %>
        <% end %>
      </div>

      <%= form_with(model: [@chat_room, Message.new], 
                    id: "message-form", 
                    class: "message-form",
                    data: { remote: true }) do |form| %>
        <div class="input-group">
          <%= form.text_field :content, 
              id: "message-input", 
              class: "form-control",
              placeholder: "Type your message...",
              autocomplete: "off" %>
          <%= form.submit "Send", 
              id: "send-button",
              class: "btn btn-primary" %>
        </div>
      <% end %>

    </div>

    <%= javascript_tag do %>
      document.addEventListener("DOMContentLoaded", () => {
        const messageForm = document.getElementById("message-form");
        const messageInput = document.getElementById("message-input");
        const messages = document.getElementById("messages");
        const chatRoomId = messages.dataset.chatRoomId;

        // Set up ActionCable subscription
        const subscription = consumer.subscriptions.create(
          { channel: "ChatChannel", room: chatRoomId },
          {
            connected() {
              console.log("Connected to chat room!");
            },
            received(data) {
              messages.insertAdjacentHTML('beforeend', data.message);
              messages.scrollTop = messages.scrollHeight;
            }
          }
        );

        // Handle form submission
        messageForm.addEventListener("submit", async (e) => {
          e.preventDefault();

          const content = messageInput.value.trim();
          if (!content) return;

          try {
            const response = await fetch(messageForm.action, {
              method: 'POST',
              headers: {
                'X-CSRF-Token': document.querySelector("[name='csrf-token']").content,
                'Content-Type': 'application/json',
                'Accept': 'application/json'
              },
              body: JSON.stringify({
                message: {
                  content: content
                }
              })
            });

            if (response.ok) {
              messageInput.value = '';
              messageInput.focus();
            }
          } catch (error) {
            console.error('Error:', error);
          }
        });

        // Initial scroll to bottom
        messages.scrollTop = messages.scrollHeight;
      });
    <% end %>
  </main>
</body>
</html>