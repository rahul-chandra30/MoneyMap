<div class="chat-container">
  <div class="chat-window">
    <div id="messages" data-chat-room-id="<%= @chat_room.id %>">
      <% @messages.each do |message| %>
        <%= render partial: 'messages/message', locals: { message: message } %>
      <% end %>
    </div>

    <%= form_with(model: [@chat_room, Message.new], 
                id: "message-form", 
                class: "message-form") do |form| %>
      <div class="input-group">
        <%= form.text_field :content, 
            id: "message-input", 
            class: "form-control",
            placeholder: "Type your message...",
            autocomplete: "off" %>
        <%= form.submit "Send", class: "btn btn-primary", data: { disable: false } %>
      </div>
    <% end %>
  </div>
</div>

<%= javascript_tag do %>
  document.addEventListener("DOMContentLoaded", () => {
    const messageForm = document.getElementById("message-form");
    const messageInput = document.getElementById("message-input");

    messageForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const content = messageInput.value.trim();
      
      if (content) {
        const chatRoomId = document.getElementById("messages").dataset.chatRoomId;
        fetch(`/chat_rooms/${chatRoomId}/messages`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': document.querySelector("[name='csrf-token']").content,
          },
          body: JSON.stringify({
            message: { content: content }
          })
        }).then(() => {
          messageInput.value = '';
          messageInput.focus();
        });
      }
    });
  });
<% end %>